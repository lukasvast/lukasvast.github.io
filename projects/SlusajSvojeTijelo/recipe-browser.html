<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 15px;
            height: calc(100vh - 20px);
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .sidebar h1 {
            font-size: 28px;
            margin-bottom: 12px;
            color: #f97316;
            font-weight: 700;
        }

        .search-box {
            width: 100%;
            padding: 14px;
            border: 2px solid #fed7aa;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .recipe-count {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .recipe-list {
            list-style: none;
        }

        .recipe-item {
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            border-left: 4px solid transparent;
            min-height: 48px;
            display: flex;
            align-items: center;
        }

        .recipe-item:hover {
            background: #fff7ed;
            border-left-color: #f97316;
            transform: translateX(2px);
        }

        .recipe-item.active {
            background: #f97316;
            color: white;
            border-left-color: #ea580c;
            font-weight: 600;
        }

        .main-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .active-filters-bar {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.1);
        }

        .active-filters-bar.visible {
            display: flex;
        }

        .active-filters-label {
            font-weight: 600;
            color: #9a3412;
            font-size: 14px;
            white-space: nowrap;
        }

        .active-filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #f97316;
            border-radius: 20px;
            font-size: 14px;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active-filter-tag:hover {
            background: #fef3e7;
            transform: translateY(-1px);
        }

        .active-filter-tag .remove-icon {
            color: #f97316;
            font-weight: bold;
            font-size: 16px;
        }

        .active-rating-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #f97316;
            border-radius: 20px;
            font-size: 14px;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active-rating-tag:hover {
            background: #fef3e7;
            transform: translateY(-1px);
        }

        .active-rating-tag .remove-icon {
            color: #f97316;
            font-weight: bold;
            font-size: 16px;
        }

        .welcome {
            text-align: center;
            padding: 100px 20px;
            color: #999;
        }

        .welcome h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .recipe-header {
            border-bottom: 3px solid #f97316;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
        }

        .recipe-title {
            font-size: 28px;
            color: #1f2937;
            flex: 1;
            line-height: 1.3;
            min-width: 250px;
        }

        .recipe-title.editing {
            border: 2px solid #f97316;
            padding: 12px;
            border-radius: 8px;
            font-size: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 48px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-edit {
            background: #f97316;
            color: white;
        }

        .btn-edit:hover {
            background: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-save {
            background: #10b981;
            color: white;
        }

        .btn-save:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-cancel {
            background: #ef4444;
            color: white;
        }

        .btn-cancel:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-export {
            background: #fb923c;
            color: white;
        }

        .btn-export:hover {
            background: #f97316;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
        }

        .recipe-section {
            margin-bottom: 30px;
        }

        .recipe-section h3 {
            font-size: 22px;
            color: #f97316;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .ingredients-list {
            list-style: none;
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
        }

        .ingredient-item {
            padding: 14px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #f97316;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            min-height: 48px;
        }

        .ingredient-item.editing {
            padding: 5px;
        }

        .ingredient-item input {
            flex: 1;
            padding: 12px;
            border: 2px solid #fed7aa;
            border-radius: 8px;
            font-size: 16px;
        }

        .ingredient-item input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-height: 40px;
            font-weight: 600;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 12px;
            min-height: 48px;
            font-weight: 600;
        }

        .btn-add:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .instructions {
            background: #fff7ed;
            padding: 24px;
            border-radius: 10px;
            line-height: 1.9;
            color: #1f2937;
            font-size: 17px;
            border-left: 4px solid #fb923c;
        }

        .instructions.editing {
            padding: 0;
        }

        /* HTML formatting within instructions */
        .instructions h1,
        .instructions h2,
        .instructions h3,
        .instructions h4 {
            color: #ea580c;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .instructions h1 { font-size: 1.5em; }
        .instructions h2 { font-size: 1.3em; }
        .instructions h3 { font-size: 1.1em; }
        .instructions h4 { font-size: 1em; }

        .instructions p {
            margin-bottom: 1em;
        }

        .instructions ul,
        .instructions ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .instructions li {
            margin-bottom: 0.5em;
        }

        .instructions strong,
        .instructions b {
            color: #ea580c;
            font-weight: 600;
        }

        .instructions em,
        .instructions i {
            color: #9a3412;
            font-style: italic;
        }

        .instructions code {
            background: #fed7aa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .instructions pre {
            background: #fed7aa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .instructions blockquote {
            border-left: 3px solid #fb923c;
            padding-left: 1em;
            margin: 1em 0;
            color: #9a3412;
            font-style: italic;
        }

        .instructions hr {
            border: none;
            border-top: 2px solid #fed7aa;
            margin: 1.5em 0;
        }

        textarea {
            width: 100%;
            min-height: 250px;
            padding: 18px;
            border: 2px solid #fed7aa;
            border-radius: 10px;
            font-size: 17px;
            font-family: inherit;
            line-height: 1.9;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Rich text editor toolbar */
        .editor-toolbar {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: #fff;
            border: 2px solid #fed7aa;
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 8px 12px;
            border: 1px solid #fed7aa;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            min-width: 40px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #fff7ed;
            border-color: #fb923c;
        }

        .toolbar-btn:active {
            background: #fed7aa;
        }

        .toolbar-separator {
            width: 1px;
            background: #fed7aa;
            margin: 0 4px;
        }

        .instructions.editing[contenteditable="true"] {
            border: 2px solid #fed7aa;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 18px;
            background: white;
        }

        .instructions.editing[contenteditable="true"]:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .no-recipes {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .stars {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 32px;
            cursor: pointer;
            color: #fed7aa;
            transition: color 0.2s, transform 0.2s;
            user-select: none;
            min-width: 40px;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .star:hover {
            transform: scale(1.3);
        }

        .star.filled {
            color: #f97316;
        }

        .star.hover {
            color: #f97316;
        }

        .rating-text {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .labels-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .label {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: #fff7ed;
            color: #1f2937;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 600;
            gap: 6px;
            border: 2px solid currentColor;
        }

        .label.editing {
            background: #fff;
            padding: 6px 14px;
        }

        .label-remove {
            cursor: pointer;
            font-weight: bold;
            color: #ef4444;
            margin-left: 5px;
        }

        .label-remove:hover {
            color: #dc2626;
        }

        .filters {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            padding: 8px;
            background: #fff7ed;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .filter-title:hover {
            background: #fed7aa;
        }

        .filter-title .toggle-icon {
            font-size: 10px;
            transition: transform 0.3s;
        }

        .filter-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .filter-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            max-height: 500px;
            opacity: 1;
        }

        .filter-labels.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .filter-label {
            padding: 10px 16px;
            background: white;
            border: 2px solid #fed7aa;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .filter-label:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-2px);
        }

        .filter-label.active {
            background: #f97316;
            color: white;
            border-color: #f97316;
        }

        .rating-filter {
            display: flex;
            gap: 5px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            max-height: 100px;
            opacity: 1;
        }

        .rating-filter.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .rating-filter .star {
            font-size: 20px;
            cursor: pointer;
        }

        .btn-manage-labels {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            width: 100%;
        }

        .btn-manage-labels:hover {
            background: #7c3aed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #667eea;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .label-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .label-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .existing-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .existing-label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 15px;
            gap: 8px;
        }

        .clear-filters {
            font-size: 11px;
            color: #667eea;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
        }

        .clear-filters:hover {
            text-decoration: underline;
        }

        @media (max-width: 968px) {
            body {
                padding: 5px;
            }

            .container {
                grid-template-columns: 1fr;
                height: auto;
                gap: 10px;
            }

            .sidebar {
                max-height: 400px;
                padding: 15px;
            }

            .sidebar h1 {
                font-size: 24px;
            }

            .main-content {
                padding: 20px;
            }

            .recipe-title {
                font-size: 24px;
                min-width: 100%;
            }

            .recipe-header {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .recipe-section h3 {
                font-size: 20px;
            }

            .instructions {
                font-size: 16px;
            }

            .label {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .recipe-title {
                font-size: 20px;
            }

            .recipe-section h3 {
                font-size: 18px;
            }

            .instructions {
                font-size: 15px;
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Recipes</h1>
            <input type="text" class="search-box" id="searchBox" placeholder="Search recipes...">

            <div class="filters" id="filters">
                <div class="filter-section">
                    <div class="filter-title collapsed" onclick="toggleFilterSection(this)">
                        <span>Labels</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="filter-labels collapsed" id="filterLabels"></div>
                </div>
                <div class="filter-section">
                    <div class="filter-title collapsed" onclick="toggleFilterSection(this)">
                        <span>Min. Rating</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="rating-filter collapsed" id="ratingFilter">
                        ${[1, 2, 3, 4, 5].map(r => `<span class="star" data-rating="${r}" onclick="filterByRating(${r})">‚òÖ</span>`).join('')}
                    </div>
                </div>
                <div class="clear-filters" onclick="clearFilters()">Clear filters</div>
                <button class="btn-manage-labels" onclick="openLabelManager()">üè∑Ô∏è Manage Labels</button>
            </div>

            <div class="recipe-count" id="recipeCount">Loading...</div>
            <ul class="recipe-list" id="recipeList"></ul>
        </div>

        <div class="main-content" id="mainContent">
            <div class="active-filters-bar" id="activeFiltersBar">
                <span class="active-filters-label">Active filters:</span>
                <div id="activeFilterTags"></div>
            </div>
            <div class="welcome">
                <h2>üëã Welcome</h2>
                <p>Select a recipe from the list</p>
            </div>
        </div>
    </div>

    <!-- Label Management Modal -->
    <div class="modal" id="labelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Labels</h3>
                <span class="modal-close" onclick="closeLabelManager()">√ó</span>
            </div>
            <div class="label-input-group">
                <input type="text" class="label-input" id="newLabelInput" placeholder="New label...">
                <button class="btn btn-save" onclick="addNewLabel()">Add</button>
            </div>
            <div class="filter-title">Existing Labels</div>
            <div class="existing-labels" id="existingLabels"></div>
        </div>
    </div>

    <script>
        let recipes = [];
        let currentRecipeIndex = null;
        let isEditing = false;
        let filteredRecipes = [];
        let availableLabels = [
            'glutenfree',
            'family friendly',
            'quick and easy',
            'low-foodmap'
        ];

        // Exclusive label groups - recipe can only have one from each group
        let exclusiveLabelGroups = {
            'Meal Type': ['breakfast', 'lunch', 'snack', 'dessert'],
            'Season': ['spring', 'summer', 'autumn', 'winter']
        };

        // Label icons and colors
        const labelConfig = {
            'glutenfree': { icon: 'üåæ', color: '#f97316' },
            'family friendly': { icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#fb923c' },
            'quick and easy': { icon: '‚ö°', color: '#fdba74' },
            'low-foodmap': { icon: 'üíö', color: '#10b981' },
            'breakfast': { icon: 'üåÖ', color: '#fb923c' },
            'lunch': { icon: 'üçΩÔ∏è', color: '#f97316' },
            'snack': { icon: 'üç™', color: '#fdba74' },
            'dessert': { icon: 'üç∞', color: '#fbbf24' },
            'spring': { icon: 'üå∏', color: '#10b981' },
            'summer': { icon: '‚òÄÔ∏è', color: '#fbbf24' },
            'autumn': { icon: 'üçÇ', color: '#ea580c' },
            'winter': { icon: '‚ùÑÔ∏è', color: '#3b82f6' }
        };

        function getLabelConfig(label) {
            return labelConfig[label] || { icon: 'üè∑Ô∏è', color: '#f97316' };
        }

        let activeFilters = {
            labels: [],
            minRating: 0
        };

        // Load recipes from server API
        async function loadRecipes() {
            try {
                const response = await fetch('/api/recipes');
                if (!response.ok) throw new Error('Failed to load recipes');
                recipes = await response.json();

                // Extract all unique labels from recipes (labels field only contains regular labels now)
                recipes.forEach(recipe => {
                    if (recipe.labels) {
                        recipe.labels.forEach(label => {
                            if (!availableLabels.includes(label)) {
                                availableLabels.push(label);
                            }
                        });
                    }
                });

                filteredRecipes = [...recipes];
                updateRecipeList();
                updateRecipeCount();
                updateFilterLabels();
                updateRatingFilterDisplay();
            } catch (error) {
                document.getElementById('recipeList').innerHTML =
                    '<div class="no-recipes">Error loading recipes.<br>Check if the server is running.</div>';
                console.error('Error loading recipes:', error);
            }
        }

        // Update recipe list in sidebar
        function updateRecipeList() {
            const listElement = document.getElementById('recipeList');
            listElement.innerHTML = '';

            filteredRecipes.forEach((recipe, index) => {
                const li = document.createElement('li');
                li.className = 'recipe-item';
                li.textContent = recipe.name;
                li.onclick = () => showRecipe(recipes.indexOf(recipe));
                listElement.appendChild(li);
            });

            if (filteredRecipes.length === 0) {
                listElement.innerHTML = '<div class="no-recipes">No results</div>';
            }
        }

        // Update recipe count
        function updateRecipeCount() {
            const countElement = document.getElementById('recipeCount');
            countElement.textContent = `${filteredRecipes.length} of ${recipes.length} recipes`;
        }

        // Apply all filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredRecipes = recipes.filter(recipe => {
                // Search filter
                if (searchTerm && !recipe.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Filter by labels, mealType, and season
                if (activeFilters.labels.length > 0) {
                    const mealTypes = exclusiveLabelGroups['Meal Type'];
                    const seasons = exclusiveLabelGroups['Season'];

                    for (const filterLabel of activeFilters.labels) {
                        if (mealTypes.includes(filterLabel)) {
                            // Check mealType field
                            if (recipe.mealType !== filterLabel) return false;
                        } else if (seasons.includes(filterLabel)) {
                            // Check season field
                            if (recipe.season !== filterLabel) return false;
                        } else {
                            // Check labels array
                            const recipeLabels = recipe.labels || [];
                            if (!recipeLabels.includes(filterLabel)) return false;
                        }
                    }
                }

                // Rating filter
                if (activeFilters.minRating > 0) {
                    const rating = recipe.rating || 0;
                    if (rating < activeFilters.minRating) return false;
                }

                return true;
            });

            // Sort by rating (highest first)
            filteredRecipes.sort((a, b) => (b.rating || 0) - (a.rating || 0));

            updateRecipeList();
            updateRecipeCount();
            updateActiveFiltersBar();
        }

        // Update the active filters bar
        function updateActiveFiltersBar() {
            const bar = document.getElementById('activeFiltersBar');
            const tagsContainer = document.getElementById('activeFilterTags');

            const hasActiveFilters = activeFilters.labels.length > 0 || activeFilters.minRating > 0;

            if (hasActiveFilters) {
                bar.classList.add('visible');

                let tagsHtml = '';

                // Add label filter tags
                activeFilters.labels.forEach(label => {
                    const config = getLabelConfig(label);
                    tagsHtml += `
                        <span class="active-filter-tag" onclick="toggleLabelFilter('${label}')">
                            ${config.icon} ${label}
                            <span class="remove-icon">√ó</span>
                        </span>
                    `;
                });

                // Add rating filter tag
                if (activeFilters.minRating > 0) {
                    tagsHtml += `
                        <span class="active-rating-tag" onclick="toggleRatingFilter(${activeFilters.minRating})">
                            ‚≠ê ${activeFilters.minRating}+ stars
                            <span class="remove-icon">√ó</span>
                        </span>
                    `;
                }

                tagsContainer.innerHTML = tagsHtml;
            } else {
                bar.classList.remove('visible');
            }
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', () => {
            applyFilters();
        });

        // Show recipe details
        function showRecipe(index) {
            if (isEditing) {
                if (!confirm('You have unsaved changes. Do you want to continue?')) {
                    return;
                }
                cancelEdit();
            }

            currentRecipeIndex = index;
            const recipe = recipes[index];

            // Highlight active recipe
            document.querySelectorAll('.recipe-item').forEach((item, i) => {
                if (recipes.indexOf(filteredRecipes[i]) === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Render recipe
            const mainContent = document.getElementById('mainContent');
            const rating = recipe.rating || 0;
            const ratingText = rating > 0 ? `${rating} ${rating === 1 ? 'star' : 'stars'}` : 'Not rated';
            const labels = recipe.labels || [];

            mainContent.innerHTML = `
                <div class="recipe-header">
                    <div style="flex: 1;">
                        <h2 class="recipe-title" id="recipeTitle">${recipe.name}</h2>
                        <div class="rating-container">
                            <div class="stars" id="starsDisplay">
                                ${[1, 2, 3, 4, 5].map(star => `
                                    <span class="star ${star <= rating ? 'filled' : ''}" data-rating="${star}" onclick="rateRecipe(${star})">‚òÖ</span>
                                `).join('')}
                            </div>
                            <span class="rating-text">${ratingText}</span>
                        </div>
                        ${labels.length > 0 ? `
                            <div class="labels-container">
                                ${labels.map(label => {
                                    const config = getLabelConfig(label);
                                    return `<span class="label" style="color: ${config.color}; border-color: ${config.color};">${config.icon} ${label}</span>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-edit" onclick="startEdit()">‚úèÔ∏è Edit</button>
                        <button class="btn btn-export" onclick="exportRecipe()">üíæ Export</button>
                    </div>
                </div>

                <div class="recipe-section">
                    <h3>üìù Ingredients</h3>
                    <ul class="ingredients-list" id="ingredientsList">
                        ${recipe.ingredients.map((ing, i) => `
                            <li class="ingredient-item" data-index="${i}">${ing}</li>
                        `).join('')}
                    </ul>
                </div>

                <div class="recipe-section">
                    <h3>üë®‚Äçüç≥ Instructions</h3>
                    <div class="instructions" id="instructions">${recipe.instructions}</div>
                </div>
            `;

            // Add hover effect for stars
            addStarHoverEffect();
        }

        // Start editing mode
        function startEdit() {
            if (currentRecipeIndex === null) return;

            isEditing = true;
            const recipe = recipes[currentRecipeIndex];
            const recipeLabels = recipe.labels || [];

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="recipe-header">
                    <input type="text" class="recipe-title editing" id="recipeTitle" value="${recipe.name}">
                    <div class="action-buttons">
                        <button class="btn btn-save" onclick="saveEdit()">‚úì Save</button>
                        <button class="btn btn-cancel" onclick="cancelEdit()">‚úó Cancel</button>
                    </div>
                </div>

                <div class="recipe-section">
                    <h3>üè∑Ô∏è Labels</h3>
                    <div class="labels-container" id="labelsEdit">
                        ${recipeLabels.map(label => {
                            const config = getLabelConfig(label);
                            return `
                                <span class="label editing" style="color: ${config.color}; border-color: ${config.color};">
                                    ${config.icon} ${label}
                                    <span class="label-remove" onclick="removeLabelByName('${label}')">‚úó</span>
                                </span>
                            `;
                        }).join('')}
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn-add" onclick="toggleLabelSelector()" style="width: 100%;">
                            ‚ûï Add/Change Labels
                        </button>

                        <div id="labelSelectorPanel" style="display: none; margin-top: 15px; padding: 15px; background: #fff7ed; border-radius: 8px; border: 2px solid #fed7aa;">
                            ${availableLabels.length > 0 ? `
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 15px; font-weight: 600; color: #f97316; display: block; margin-bottom: 8px;">Regular Labels</label>
                                    <select id="labelSelect" onchange="addLabelToRecipe(this.value)" style="width: 100%; padding: 12px; border: 2px solid #fed7aa; border-radius: 8px; font-size: 16px;">
                                        <option value="">+ Add label</option>
                                        ${availableLabels.filter(l => !recipeLabels.includes(l)).map(label => {
                                            const config = getLabelConfig(label);
                                            return `<option value="${label}">${config.icon} ${label}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            ` : ''}

                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 15px; font-weight: 600; color: #f97316; display: block; margin-bottom: 8px;">Meal Type</label>
                                <select id="mealTypeSelect" onchange="updateMealType(this.value)" style="width: 100%; padding: 12px; border: 2px solid #fed7aa; border-radius: 8px; font-size: 16px;">
                                    <option value="">None</option>
                                    ${exclusiveLabelGroups['Meal Type'].map(label => {
                                        const config = getLabelConfig(label);
                                        return `<option value="${label}" ${recipe.mealType === label ? 'selected' : ''}>${config.icon} ${label}</option>`;
                                    }).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 15px; font-weight: 600; color: #f97316; display: block; margin-bottom: 8px;">Season</label>
                                <select id="seasonSelect" onchange="updateSeason(this.value)" style="width: 100%; padding: 12px; border: 2px solid #fed7aa; border-radius: 8px; font-size: 16px;">
                                    <option value="">None</option>
                                    ${exclusiveLabelGroups['Season'].map(label => {
                                        const config = getLabelConfig(label);
                                        return `<option value="${label}" ${recipe.season === label ? 'selected' : ''}>${config.icon} ${label}</option>`;
                                    }).join('')}
                                </select>
                            </div>

                            <button class="btn" style="width: 100%; background: #9ca3af; margin-top: 10px;" onclick="toggleLabelSelector()">
                                ‚úì Done
                            </button>
                        </div>
                    </div>
                </div>

                <div class="recipe-section">
                    <h3>üìù Ingredients</h3>
                    <ul class="ingredients-list" id="ingredientsList">
                        ${recipe.ingredients.map((ing, i) => `
                            <li class="ingredient-item editing">
                                <input type="text" value="${ing}" data-index="${i}">
                                <button class="btn-delete" onclick="deleteIngredient(${i})">‚úó</button>
                            </li>
                        `).join('')}
                    </ul>
                    <button class="btn btn-add" onclick="addIngredient()">+ Add ingredient</button>
                </div>

                <div class="recipe-section">
                    <h3>üë®‚Äçüç≥ Instructions</h3>

                    <!-- Rich text editor toolbar -->
                    <div class="editor-toolbar">
                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                            <em>I</em>
                        </button>
                        <span class="toolbar-separator"></span>
                        <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">
                            ‚â°
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bulleted List">
                            ‚Ä¢
                        </button>
                        <span class="toolbar-separator"></span>
                        <button type="button" class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">
                            ‚úï
                        </button>
                    </div>

                    <div class="instructions editing"
                         id="instructionsEditor"
                         contenteditable="true"
                         style="min-height: 250px; max-height: 500px; overflow-y: auto; cursor: text;">${recipe.instructions}</div>
                </div>
            `;
        }

        // Save edits
        async function saveEdit() {
            if (currentRecipeIndex === null) return;

            const recipe = recipes[currentRecipeIndex];

            // Update name
            recipe.name = document.getElementById('recipeTitle').value;

            // Update labels - Note: recipe.labels already contains all labels (regular + exclusive)
            // The exclusive labels are managed through dropdowns and already updated in recipe.labels
            // The regular labels are displayed and can be removed, so we don't need to update them here
            // Labels are already up-to-date from addLabelToRecipe() and removeLabelByName() calls

            // Update ingredients
            const ingredientInputs = document.querySelectorAll('#ingredientsList input');
            recipe.ingredients = Array.from(ingredientInputs).map(input => input.value).filter(v => v.trim());

            // Update instructions from rich text editor
            const instructionsEditor = document.getElementById('instructionsEditor');
            recipe.instructions = instructionsEditor.innerHTML;

            // Save to server
            try {
                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(recipes)
                });

                const result = await response.json();

                if (response.ok) {
                    isEditing = false;
                    updateRecipeList();
                    showRecipe(currentRecipeIndex);
                    alert('‚úì Recipe saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving: ' + error.message);
                console.error('Error saving recipe:', error);
            }
        }

        // Cancel editing
        function cancelEdit() {
            isEditing = false;
            if (currentRecipeIndex !== null) {
                showRecipe(currentRecipeIndex);
            }
        }

        // Delete ingredient
        function deleteIngredient(index) {
            const ingredient = document.querySelector(`#ingredientsList input[data-index="${index}"]`);
            if (ingredient) {
                ingredient.closest('.ingredient-item').remove();
            }
        }

        // Add new ingredient
        function addIngredient() {
            const list = document.getElementById('ingredientsList');
            const newIndex = list.children.length;
            const li = document.createElement('li');
            li.className = 'ingredient-item editing';
            li.innerHTML = `
                <input type="text" value="" data-index="${newIndex}" placeholder="Novi sastojak">
                <button class="btn-delete" onclick="deleteIngredient(${newIndex})">‚úó</button>
            `;
            list.appendChild(li);
            li.querySelector('input').focus();
        }

        // Export recipe data as JSON
        function exportRecipe() {
            const dataStr = JSON.stringify(recipes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'recipes.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Rate recipe
        async function rateRecipe(rating) {
            if (currentRecipeIndex === null) return;

            const recipe = recipes[currentRecipeIndex];
            recipe.rating = rating;

            // Save to server
            try {
                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(recipes)
                });

                const result = await response.json();

                if (response.ok) {
                    // Update UI
                    showRecipe(currentRecipeIndex);
                } else {
                    alert('Error saving rating: ' + result.error);
                }
            } catch (error) {
                alert('Error saving rating: ' + error.message);
                console.error('Error saving rating:', error);
            }
        }

        // Add star hover effect
        function addStarHoverEffect() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', () => {
                    stars.forEach((s, i) => {
                        if (i <= index) {
                            s.classList.add('hover');
                        } else {
                            s.classList.remove('hover');
                        }
                    });
                });

                star.addEventListener('mouseleave', () => {
                    stars.forEach(s => s.classList.remove('hover'));
                });
            });
        }

        // Label management in edit mode
        function addLabelToRecipe(label) {
            if (!label) return;

            const recipe = recipes[currentRecipeIndex];
            if (!recipe.labels) recipe.labels = [];

            if (!recipe.labels.includes(label)) {
                recipe.labels.push(label);
                startEdit(); // Refresh edit view
            }
        }

        function updateMealType(mealType) {
            const recipe = recipes[currentRecipeIndex];
            if (mealType === '') {
                delete recipe.mealType;
            } else {
                recipe.mealType = mealType;
            }
            startEdit(); // Refresh edit view
        }

        function updateSeason(season) {
            const recipe = recipes[currentRecipeIndex];
            if (season === '') {
                delete recipe.season;
            } else {
                recipe.season = season;
            }
            startEdit(); // Refresh edit view
        }

        function removeLabel(index) {
            const recipe = recipes[currentRecipeIndex];
            if (recipe.labels) {
                recipe.labels.splice(index, 1);
                startEdit(); // Refresh edit view
            }
        }

        function removeLabelByName(labelName) {
            const recipe = recipes[currentRecipeIndex];
            if (recipe.labels) {
                const index = recipe.labels.indexOf(labelName);
                if (index > -1) {
                    recipe.labels.splice(index, 1);
                    startEdit(); // Refresh edit view
                }
            }
        }

        function toggleLabelSelector() {
            const panel = document.getElementById('labelSelectorPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleFilterSection(titleElement) {
            titleElement.classList.toggle('collapsed');
            const section = titleElement.parentElement;
            const content = section.querySelector('.filter-labels, .rating-filter');
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        // Filter functions
        function updateFilterLabels() {
            const filterLabelsEl = document.getElementById('filterLabels');

            let html = '';

            // Regular labels
            if (availableLabels.length > 0) {
                html += availableLabels.map(label => {
                    const config = getLabelConfig(label);
                    const isActive = activeFilters.labels.includes(label);
                    return `
                        <span class="filter-label ${isActive ? 'active' : ''}"
                              onclick="event.stopPropagation(); toggleLabelFilter('${label}');"
                              style="${!isActive ? `border-color: ${config.color};` : ''}">
                            ${config.icon} ${label}
                        </span>
                    `;
                }).join('');
            }

            filterLabelsEl.innerHTML = html;

            // Add exclusive label groups
            const filtersContainer = document.getElementById('filters');
            const existingSections = filtersContainer.querySelectorAll('.filter-section');

            // Save the collapsed state of each section before rebuilding
            const collapsedStates = {};
            existingSections.forEach((section, index) => {
                if (index >= 2) {
                    const titleEl = section.querySelector('.filter-title');
                    const titleText = titleEl ? titleEl.querySelector('span').textContent : null;
                    if (titleText) {
                        collapsedStates[titleText] = titleEl.classList.contains('collapsed');
                    }
                    section.remove();
                }
            });

            // Add exclusive label group sections
            Object.entries(exclusiveLabelGroups).forEach(([groupName, groupLabels]) => {
                // Check if this section was previously expanded (not collapsed)
                const isCollapsed = collapsedStates[groupName] !== false; // Default to collapsed if not found

                const section = document.createElement('div');
                section.className = 'filter-section';
                section.innerHTML = `
                    <div class="filter-title ${isCollapsed ? 'collapsed' : ''}" onclick="toggleFilterSection(this)">
                        <span>${groupName}</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="filter-labels ${isCollapsed ? 'collapsed' : ''}">
                        ${groupLabels.map(label => {
                            const config = getLabelConfig(label);
                            const isActive = activeFilters.labels.includes(label);
                            return `
                                <span class="filter-label ${isActive ? 'active' : ''}"
                                      onclick="event.stopPropagation(); toggleLabelFilter('${label}');"
                                      style="${!isActive ? `border-color: ${config.color};` : ''}">
                                    ${config.icon} ${label}
                                </span>
                            `;
                        }).join('')}
                    </div>
                `;
                // Insert before clear filters button
                const clearFiltersEl = filtersContainer.querySelector('.clear-filters');
                filtersContainer.insertBefore(section, clearFiltersEl);
            });
        }

        function toggleLabelFilter(label) {
            const mealTypes = exclusiveLabelGroups['Meal Type'];
            const seasons = exclusiveLabelGroups['Season'];

            // Check if this is an exclusive label (meal type or season)
            const isMealType = mealTypes.includes(label);
            const isSeason = seasons.includes(label);

            if (isMealType || isSeason) {
                // Single-select behavior for exclusive labels
                const exclusiveLabels = isMealType ? mealTypes : seasons;

                // Remove all labels from this exclusive group
                activeFilters.labels = activeFilters.labels.filter(l => !exclusiveLabels.includes(l));

                // Toggle the clicked label
                const index = activeFilters.labels.indexOf(label);
                if (index === -1) {
                    activeFilters.labels.push(label);
                }
            } else {
                // Multi-select behavior for regular labels
                const index = activeFilters.labels.indexOf(label);
                if (index > -1) {
                    activeFilters.labels.splice(index, 1);
                } else {
                    activeFilters.labels.push(label);
                }
            }

            updateFilterLabels();
            applyFilters();
        }

        // Rich text editor functions
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('instructionsEditor').focus();
        }

        function clearFormatting() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const selectedText = range.toString();

            if (selectedText) {
                const textNode = document.createTextNode(selectedText);
                range.deleteContents();
                range.insertNode(textNode);
            }

            document.getElementById('instructionsEditor').focus();
        }

        // Add keyboard shortcuts for rich text editor
        document.addEventListener('keydown', function(e) {
            const editor = document.getElementById('instructionsEditor');
            if (!editor || document.activeElement !== editor) return;

            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        formatText('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        formatText('italic');
                        break;
                }
            }
        });

        function filterByRating(rating) {
            activeFilters.minRating = rating;
            updateRatingFilterDisplay();
            applyFilters();
        }

        function updateRatingFilterDisplay() {
            const stars = document.querySelectorAll('#ratingFilter .star');
            stars.forEach((star, index) => {
                const starRating = index + 1;
                if (starRating <= activeFilters.minRating) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        }

        function clearFilters() {
            activeFilters.labels = [];
            activeFilters.minRating = 0;
            document.getElementById('searchBox').value = '';
            updateFilterLabels();
            updateRatingFilterDisplay();
            applyFilters();
        }

        // Label management modal
        function openLabelManager() {
            document.getElementById('labelModal').classList.add('active');
            updateExistingLabels();
        }

        function closeLabelManager() {
            document.getElementById('labelModal').classList.remove('active');
        }

        function updateExistingLabels() {
            const existingLabelsEl = document.getElementById('existingLabels');
            const exclusiveLabels = Object.values(exclusiveLabelGroups).flat();

            // Show regular labels
            let html = '<div style="margin-bottom: 15px;"><strong>Regular Labels</strong></div>';
            html += availableLabels.map(label => `
                <div class="existing-label">
                    <span>${label}</span>
                    <span class="label-remove" onclick="deleteLabel('${label}')">‚úó</span>
                </div>
            `).join('');

            // Show exclusive label groups (read-only)
            Object.entries(exclusiveLabelGroups).forEach(([groupName, groupLabels]) => {
                html += `<div style="margin-top: 20px; margin-bottom: 10px;"><strong>${groupName}</strong> (exclusive)</div>`;
                html += groupLabels.map(label => `
                    <div class="existing-label" style="opacity: 0.7;">
                        <span>${label}</span>
                        <span style="color: #999;">‚ö†Ô∏è</span>
                    </div>
                `).join('');
            });

            existingLabelsEl.innerHTML = html;
        }

        function addNewLabel() {
            const input = document.getElementById('newLabelInput');
            const newLabel = input.value.trim().toLowerCase();

            if (!newLabel) {
                alert('Please enter a label name');
                return;
            }

            // Check if it's an exclusive label
            const exclusiveLabels = Object.values(exclusiveLabelGroups).flat();
            if (exclusiveLabels.includes(newLabel)) {
                alert('This label is part of an exclusive group and cannot be added as a regular label');
                return;
            }

            if (availableLabels.includes(newLabel)) {
                alert('Label already exists');
                return;
            }

            availableLabels.push(newLabel);
            input.value = '';
            updateExistingLabels();
            updateFilterLabels();
        }

        function deleteLabel(label) {
            if (!confirm(`Do you want to delete the label "${label}"? It will be removed from all recipes.`)) {
                return;
            }

            // Remove from available labels
            const index = availableLabels.indexOf(label);
            if (index > -1) {
                availableLabels.splice(index, 1);
            }

            // Remove from all recipes
            recipes.forEach(recipe => {
                if (recipe.labels) {
                    recipe.labels = recipe.labels.filter(l => l !== label);
                }
            });

            updateExistingLabels();
            updateFilterLabels();
            applyFilters();
        }

        // Fix rating filter HTML
        function initRatingFilter() {
            const ratingFilterEl = document.getElementById('ratingFilter');
            ratingFilterEl.innerHTML = [1, 2, 3, 4, 5].map(r =>
                `<span class="star" data-rating="${r}" onclick="filterByRating(${r})">‚òÖ</span>`
            ).join('');
        }

        // Initialize
        initRatingFilter();
        loadRecipes();
    </script>
</body>
</html>
